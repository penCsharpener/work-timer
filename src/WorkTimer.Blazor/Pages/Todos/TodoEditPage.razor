@page "/todos/edit/{TodoId:int}"
@page "/todos/add"
@using System.Text.RegularExpressions
@using WorkTimer.Blazor.Validation
@using WorkTimer.Domain.Models.Enums

<MudCard>
  <MudForm Model="@_result.Todo" @ref="@form" Validation="@(todoValidator.ValidateValue)" ValidationDelay="0">
    <MudCardContent>
      <MudTextField @bind-Value="_result.Todo.Title"
                    For="@(() => _result.Todo.Title)"
                    Immediate="true"
                    Label="Title" />

      <MudTextField @bind-Value="_result.Todo.Description"
                    For="@(() => _result.Todo.Description)"
                    Immediate="true"
                    Lines="20"
                    Label="Description" />

      <MudDatePicker @bind-Value="_result.Todo.Deadline"
                    For="@(() => _result.Todo.Deadline)"
                     Clearable="true"
                     MinDate="DateTime.Now.AddDays(-1)"
                     Required="false"
                     Label="Deadline" />

      <MudSelect T="TodoPriority" @bind-Value="_result.Todo.Priority"
                    For="@(() => _result.Todo.Priority)"
                    Immediate="true"
                    Label="Priority" >
                    @foreach (var item in Enum.GetValues<TodoPriority>())
                    {
                      <MudSelectItem Value="item">@item.ToString()</MudSelectItem>
                    }
      </MudSelect>

      <MudCheckBox @bind-Value="_result.Todo.IsContractIndependent"
                   For="@(() => _result.Todo.IsContractIndependent)"
                    Label="For all contracts?" />
    </MudCardContent>
  </MudForm>
  <MudCardActions>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" OnClick="@(async () => await SubmitAsync())">Save</MudButton>
  </MudCardActions>
</MudCard>

<div class="fixed-add-button">
  <MudFab Color="Color.Secondary" Icon="@Icons.Material.Filled.Delete" OnClick="DeleteAsync"></MudFab>
</div>

@code {

  [Parameter]
  public int TodoId { get; set; }

  private TodoEditValidator todoValidator = new TodoEditValidator();
  private GetTodoQueryResult _result;
  MudForm? form;

  protected override async Task OnInitializedAsync()
  {
    if (TodoId == 0)
    {
      _result = new() { Todo = new() };

      return;
    }

    _result = await Mediator.Send<GetTodoQueryResult>(new GetTodoQuery { Id = TodoId });
  }

  public async Task SubmitAsync()
  {
    if (form == null)
    {
      return;
    }

    await form.Validate();

    if (!form.IsValid)
    {
      return;
    }

    if (TodoId == 0)
    {
      var newTodoId = await Mediator.Send(new AddTodoCommand { Todo = _result.Todo });
      _result.Todo.Id = newTodoId;
      NavigationManager.NavigateTo($"/todos/edit/{newTodoId}");

      return;
    }

    await Mediator.Send(new EditTodoCommand { Todo = _result.Todo });

    NavigationManager.NavigateTo("/todos");
  }

  private async Task DeleteAsync()
  {
    if (TodoId == 0)
    {
      return;
    }

    await Mediator.Send(new DeleteTodoCommand(TodoId));

    NavigationManager.NavigateTo("/todos");
  }
}
